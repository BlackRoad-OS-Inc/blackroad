# BlackRoad Multi-Domain Configuration - Full Fleet
# Routes: blackroad.io, blackroad.ai, blackroad.network, lucidia.earth, lucidia.studio, etc.

# Subdomain map for .blackroad.io
map $host $site_root {
    default                           /var/www/blackroad;
    "~^(?<sub>[^.]+)\.blackroad\.io$" /var/www/blackroad/blackroad-$sub;
    "~^(?<sub>[^.]+)\.blackroad\.ai$" /var/www/blackroad/blackroad-$sub;
    "~^(?<sub>[^.]+)\.blackroad\.systems$" /var/www/blackroad/blackroad-$sub;
    "~^(?<sub>[^.]+)\.blackroad\.network$" /var/www/blackroad/blackroad-$sub;
    "blackroad.io"                    /var/www/blackroad;
    "blackroad.ai"                    /var/www/blackroad;
    "blackroad.network"               /var/www/blackroad/blackroad-network;
    "lucidia.earth"                   /var/www/blackroad/lucidia-earth;
    "lucidia.studio"                  /var/www/blackroad/lucidia-studio;
    "lucidia.ai"                      /var/www/blackroad/blackroad-ai;
    "blackroad.inc"                   /var/www/blackroad/blackroad-inc;
    "blackroad.me"                    /var/www/blackroad/blackroad-me;
}

# Service proxy map (subdomains â†’ backend services on octavia)
map $host $proxy_pass {
    default                           "";
    "api.blackroad.io"                "http://127.0.0.1:8787";
    "api.blackroad.ai"                "http://127.0.0.1:8787";
    "agents.blackroad.io"             "http://127.0.0.1:4010";
    "docs.blackroad.io"               "http://127.0.0.1:3001";
    "dashboard.blackroad.io"          "http://127.0.0.1:3000";
    "metrics.blackroad.io"            "http://127.0.0.1:9090";
    "grafana.blackroad.io"            "http://127.0.0.1:3109";
    "nats.blackroad.io"               "http://127.0.0.1:8222";
    "db.blackroad.io"                 "http://127.0.0.1:8080";
    "ollama.blackroad.io"             "http://127.0.0.1:11434";
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    
    # Proxy services first
    location / {
        if ($proxy_pass != "") {
            proxy_pass $proxy_pass;
            break;
        }
        root $site_root;
        index index.html;
        try_files $uri $uri/ /index.html =404;
    }

    # Direct path access for all apps
    location ~ ^/(blackroad-[^/]+|lucidia-[^/]+)/?$ {
        alias /var/www/blackroad/$1/;
        index index.html;
        try_files /index.html =404;
    }
    
    location ~ ^/(blackroad-[^/]+|lucidia-[^/]+)/(.+)$ {
        alias /var/www/blackroad/$1/$2;
        try_files $uri $uri/ =404;
    }

    # Status endpoint
    location /nginx-status {
        stub_status on;
        allow 127.0.0.1;
        deny all;
    }
    
    # Health check
    location /health {
        return 200 '{"status":"ok","fleet":"blackroad","runner":"octavia-pi5"}';
        add_header Content-Type application/json;
    }
}
