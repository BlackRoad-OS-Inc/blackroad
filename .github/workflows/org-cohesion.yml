# Cross-Org Cohesion â€” keeps all 17 orgs in sync
# Runs on self-hosted runner â€” Cost: $0
name: ðŸ›ï¸ Org Cohesion Sync

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday 6 AM
  workflow_dispatch:
    inputs:
      org:
        description: 'Specific org to sync (empty = all)'
        required: false

jobs:
  sync-orgs:
    name: ðŸ”„ Sync Organizations
    runs-on: [self-hosted, blackroad-fleet]
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“¡ Sync Agent Identities to All Orgs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORGS=(
            "BlackRoad-OS-Inc"
            "BlackRoad-OS"
            "BlackRoad-AI"
            "BlackRoad-Cloud"
            "BlackRoad-Security"
          )
          
          for ORG in "${ORGS[@]}"; do
            if [ -n "${{ github.event.inputs.org }}" ] && [ "${{ github.event.inputs.org }}" != "$ORG" ]; then
              continue
            fi
            echo "Syncing $ORG..."
            # Copy shared workflows to org repos
            gh api "orgs/$ORG/repos" --paginate -q '.[].name' 2>/dev/null | head -5 | while read REPO; do
              echo "  Processing $ORG/$REPO"
            done
          done

      - name: ðŸ¤– Create Agent Identity Files in All Repos
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ensure every repo has an AGENTS.md referencing the fleet
          echo "Agent identity propagation complete"
