name: "Continuous Loop ‚Äî 24h+3s"

# Self-triggering continuous workflow
# Runs 24h+3s, then re-triggers itself
# Runs FREE on self-hosted Pi runners ‚Üí $0 billable time

on:
  workflow_dispatch:
    inputs:
      loop_id:
        description: 'Loop iteration ID'
        required: false
        default: '1'
      agent:
        description: 'Agent to assign this loop to'
        required: false
        default: 'OCTAVIA'
        type: choice
        options:
          - OCTAVIA
          - ALICE
          - ARIA
          - GEMATRIA
  schedule:
    - cron: '0 0 * * *'  # Fallback daily trigger

env:
  LOOP_DURATION: 86403   # 24 hours + 3 seconds
  REPO: ${{ github.repository }}

jobs:
  continuous-loop:
    name: "Loop ${{ github.event.inputs.loop_id || '1' }} ‚Äî ${{ github.event.inputs.agent || 'OCTAVIA' }}"
    runs-on: [self-hosted, pi, arm64]
    timeout-minutes: 1500  # 25h timeout safety

    steps:
      - name: "üîÅ Loop Start"
        run: |
          LOOP_ID="${{ github.event.inputs.loop_id || '1' }}"
          AGENT="${{ github.event.inputs.agent || 'OCTAVIA' }}"
          echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
          echo "‚îÇ  BLACKROAD CONTINUOUS LOOP               ‚îÇ"
          echo "‚îÇ  Loop: #${LOOP_ID}                      ‚îÇ"
          echo "‚îÇ  Agent: ${AGENT}                        ‚îÇ"
          echo "‚îÇ  Duration: 86403s (24h+3s)              ‚îÇ"
          echo "‚îÇ  Cost: \$0 (self-hosted)                 ‚îÇ"
          echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
          echo "LOOP_ID=${LOOP_ID}" >> $GITHUB_ENV
          echo "AGENT=${AGENT}" >> $GITHUB_ENV
          echo "STARTED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: "üìã Checkout"
        uses: actions/checkout@v4

      - name: "üß† Log to memory"
        run: |
          echo "{\"ts\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"event\":\"loop_start\",\"loop\":\"$LOOP_ID\",\"agent\":\"$AGENT\",\"runner\":\"$(hostname)\"}" \
            >> ~/.blackroad/memory/journals/master-journal.jsonl || true

      - name: "üíì Health pulse ‚Äî every 1h for 24h"
        run: |
          AGENT="${{ env.AGENT }}"
          for i in $(seq 1 24); do
            echo "[$(date -u +%H:%M:%SZ)] Loop #${LOOP_ID} ‚Äî tick ${i}/24 ‚Äî agent=${AGENT} ‚Äî $(hostname)"
            
            # Run health checks each tick
            bash tools/health-check/br-health-check.sh status 2>/dev/null || true
            
            # Log tick to memory
            echo "{\"ts\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"event\":\"loop_tick\",\"loop\":\"${{ env.LOOP_ID }}\",\"tick\":${i},\"agent\":\"${AGENT}\"}" \
              >> ~/.blackroad/memory/journals/master-journal.jsonl || true

            sleep 3600  # 1 hour
          done
          
          # Final 3 second wait (24h + 3s total)
          sleep 3

      - name: "üîÑ Trigger next loop"
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_LOOP=$(( ${{ env.LOOP_ID }} + 1 ))
          echo "Triggering loop #${NEXT_LOOP}..."
          gh workflow run continuous-loop.yml \
            --repo "${{ env.REPO }}" \
            --field loop_id="${NEXT_LOOP}" \
            --field agent="${{ env.AGENT }}" \
            && echo "‚úÖ Loop #${NEXT_LOOP} triggered" \
            || echo "‚ö†Ô∏è  Re-trigger failed ‚Äî cron fallback will restart"

      - name: "üìä Loop summary"
        if: always()
        run: |
          echo "Loop #${{ env.LOOP_ID }} complete"
          echo "Agent: ${{ env.AGENT }}"
          echo "Started: ${{ env.STARTED_AT }}"
          echo "Ended: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Next loop: #$(( ${{ env.LOOP_ID }} + 1 ))"
          echo "Total billable: \$0.00 (self-hosted runner)"
