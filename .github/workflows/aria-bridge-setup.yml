name: Aria Pi Bridge Setup
on:
  workflow_dispatch:
jobs:
  setup-bridge:
    runs-on: [self-hosted, aria-pi4]
    steps:
      - name: Check and setup ollama-bridge
        run: |
          # Check if bridge is already running
          if systemctl is-active ollama-bridge 2>/dev/null; then
            echo "Bridge already running as systemd service"
            curl -sf http://localhost:4010/health
            exit 0
          fi
          # Check if process is running without systemd
          if curl -sf http://localhost:4010/health; then
            echo "Bridge running without systemd - will install service"
          fi
          # Find existing bridge source
          BRIDGE_SRC=$(find /srv /home /opt -name "server.js" 2>/dev/null | xargs grep -l "4010" 2>/dev/null | head -1)
          if [ -z "$BRIDGE_SRC" ]; then
            sudo mkdir -p /srv/ollama-bridge
            BRIDGE_SRC=/srv/ollama-bridge/server.js
            printf 'import http from "http";\nconst PORT=4010;\nconst server=http.createServer(async(req,res)=>{if(req.url==="/health"){res.writeHead(200,{"Content-Type":"application/json"});res.end(JSON.stringify({ok:true,bridge:"ollama"}));return;}const r=await fetch("http://127.0.0.1:11434"+req.url,{method:req.method});res.writeHead(r.status);res.end(Buffer.from(await r.arrayBuffer()));});server.listen(PORT,"0.0.0.0",()=>console.log("Bridge on",PORT));\n' | sudo tee "$BRIDGE_SRC"
          fi
          echo "Using bridge source: $BRIDGE_SRC"
          # Install systemd service
          printf '[Unit]\nDescription=Ollama Bridge\nAfter=network.target\n\n[Service]\nType=simple\nExecStart=/usr/bin/node %s\nRestart=always\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\n' "$BRIDGE_SRC" | sudo tee /etc/systemd/system/ollama-bridge.service
          sudo systemctl daemon-reload
          sudo systemctl enable --now ollama-bridge
          sleep 3
          systemctl is-active ollama-bridge && echo "Service active" || echo "Service start may have failed"
          curl -sf http://localhost:4010/health || echo "Health check will pass after Ollama starts"
