name: Deploy All Domains â€” CF Pages + Workers + Live Data

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      scope:
        description: 'What to deploy'
        required: false
        default: 'all'
        type: choice
        options: [all, live-data-worker, blackroad-io, blackroad-os-web, agents-dashboard, lucidia-earth, subdomain-workers]

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Auth helper used by all wrangler jobs
defaults:
  run:
    shell: bash

jobs:
  # â”€â”€ Step 1: Deploy the live-data aggregator Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-live-data-worker:
    name: "â˜ï¸ Live Data Worker"
    runs-on: [self-hosted, blackroad-fleet]
    if: ${{ github.event.inputs.scope == 'all' || github.event.inputs.scope == 'live-data-worker' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v6
      - name: Restore wrangler auth
        run: |
          if [ -n "$WRANGLER_CONFIG_B64" ]; then
            mkdir -p ~/.wrangler/config
            echo "$WRANGLER_CONFIG_B64" | base64 -d > ~/.wrangler/config/default.toml
            echo "âœ… wrangler auth restored"
          fi
        env:
          WRANGLER_CONFIG_B64: ${{ secrets.WRANGLER_CONFIG_B64 }}
      - name: Deploy blackroad-live-data worker
        run: |
          export PATH="$HOME/npm-global/bin:$HOME/bin:$PATH"
          if command -v wrangler >/dev/null 2>&1; then
            wrangler deploy --config wrangler-configs/blackroad-live-data.toml
            echo "âœ… blackroad-live-data worker deployed"
          else
            echo "âš ï¸ wrangler not available on this runner"
          fi

  # â”€â”€ Step 2: Deploy blackroad.io (static HTML with live data) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-blackroad-io:
    name: "ðŸŒ blackroad.io"
    runs-on: [self-hosted, blackroad-fleet]
    needs: [deploy-live-data-worker]
    if: ${{ always() && (github.event.inputs.scope == 'all' || github.event.inputs.scope == 'blackroad-io' || github.event_name == 'push') }}
    steps:
      - uses: actions/checkout@v6
      - name: Restore wrangler auth
        run: |
          if [ -n "$WRANGLER_CONFIG_B64" ]; then
            mkdir -p ~/.wrangler/config
            echo "$WRANGLER_CONFIG_B64" | base64 -d > ~/.wrangler/config/default.toml
            echo "âœ… wrangler auth restored"
          fi
        env:
          WRANGLER_CONFIG_B64: ${{ secrets.WRANGLER_CONFIG_B64 }}
      - name: Deploy to CF Pages â€” blackroad-io
        run: |
          export PATH="$HOME/npm-global/bin:$HOME/bin:$PATH"
          if command -v wrangler >/dev/null 2>&1; then
            wrangler pages deploy orgs/core/blackroad-io --project-name=blackroad-io --commit-dirty=true
            echo "âœ… blackroad.io deployed"
          else
            echo "âš ï¸ wrangler not available"
          fi

  # â”€â”€ Step 3: Deploy blackroad-os-web (Next.js) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-blackroad-os-web:
    name: "âš›ï¸ blackroad-os-web (Next.js)"
    runs-on: [self-hosted, blackroad-fleet]
    needs: [deploy-live-data-worker]
    if: ${{ always() && (github.event.inputs.scope == 'all' || github.event.inputs.scope == 'blackroad-os-web' || github.event_name == 'push') }}
    steps:
      - uses: actions/checkout@v6
      - name: Restore wrangler auth
        run: |
          if [ -n "$WRANGLER_CONFIG_B64" ]; then
            mkdir -p ~/.wrangler/config
            echo "$WRANGLER_CONFIG_B64" | base64 -d > ~/.wrangler/config/default.toml
            echo "âœ… wrangler auth restored"
          fi
        env:
          WRANGLER_CONFIG_B64: ${{ secrets.WRANGLER_CONFIG_B64 }}
      - name: Install & Build Next.js
        working-directory: orgs/core/blackroad-os-web
        run: |
          export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
          npm install --legacy-peer-deps
          npm run build
      - name: Deploy to CF Pages â€” blackroad-os-web
        working-directory: orgs/core/blackroad-os-web
        run: |
          export PATH="$HOME/npm-global/bin:$HOME/bin:$PATH"
          if command -v wrangler >/dev/null 2>&1; then
            wrangler pages deploy out --project-name=blackroad-os-web --commit-dirty=true
            echo "âœ… blackroad-os-web deployed"
          fi

  # â”€â”€ Step 4: Deploy agents dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-agents-dashboard:
    name: "ðŸ¤– Agents Dashboard"
    runs-on: [self-hosted, blackroad-fleet]
    needs: [deploy-live-data-worker]
    if: ${{ always() && (github.event.inputs.scope == 'all' || github.event.inputs.scope == 'agents-dashboard' || github.event_name == 'push') }}
    steps:
      - uses: actions/checkout@v6
      - name: Restore wrangler auth
        run: |
          if [ -n "$WRANGLER_CONFIG_B64" ]; then
            mkdir -p ~/.wrangler/config
            echo "$WRANGLER_CONFIG_B64" | base64 -d > ~/.wrangler/config/default.toml
            echo "âœ… wrangler auth restored"
          fi
        env:
          WRANGLER_CONFIG_B64: ${{ secrets.WRANGLER_CONFIG_B64 }}
      - name: Deploy to CF Pages â€” blackroad-agents
        run: |
          export PATH="$HOME/npm-global/bin:$HOME/bin:$PATH"
          if command -v wrangler >/dev/null 2>&1; then
            wrangler pages deploy orgs/core/blackroad-agents --project-name=blackroad-agents --commit-dirty=true
            echo "âœ… agents dashboard deployed"
          fi

  # â”€â”€ Step 5: Deploy lucidia.earth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-lucidia-earth:
    name: "ðŸŒ lucidia.earth"
    runs-on: [self-hosted, blackroad-fleet]
    needs: [deploy-live-data-worker]
    if: ${{ always() && (github.event.inputs.scope == 'all' || github.event.inputs.scope == 'lucidia-earth' || github.event_name == 'push') }}
    steps:
      - uses: actions/checkout@v6
      - name: Restore wrangler auth
        run: |
          if [ -n "$WRANGLER_CONFIG_B64" ]; then
            mkdir -p ~/.wrangler/config
            echo "$WRANGLER_CONFIG_B64" | base64 -d > ~/.wrangler/config/default.toml
            echo "âœ… wrangler auth restored"
          fi
        env:
          WRANGLER_CONFIG_B64: ${{ secrets.WRANGLER_CONFIG_B64 }}
      - name: Deploy to CF Pages â€” lucidia-earth
        run: |
          export PATH="$HOME/npm-global/bin:$HOME/bin:$PATH"
          if command -v wrangler >/dev/null 2>&1; then
            wrangler pages deploy orgs/core/lucidia-earth --project-name=lucidia-earth --commit-dirty=true
            echo "âœ… lucidia.earth deployed"
          fi

  # â”€â”€ Step 6: Deploy all subdomain workers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-subdomain-workers:
    name: "âš™ï¸ Subdomain Workers"
    runs-on: [self-hosted, blackroad-fleet]
    needs: [deploy-live-data-worker]
    if: ${{ always() && (github.event.inputs.scope == 'all' || github.event.inputs.scope == 'subdomain-workers' || github.event_name == 'push') }}
    steps:
      - uses: actions/checkout@v6
      - name: Restore wrangler auth
        run: |
          if [ -n "$WRANGLER_CONFIG_B64" ]; then
            mkdir -p ~/.wrangler/config
            echo "$WRANGLER_CONFIG_B64" | base64 -d > ~/.wrangler/config/default.toml
            echo "âœ… wrangler auth restored"
          fi
        env:
          WRANGLER_CONFIG_B64: ${{ secrets.WRANGLER_CONFIG_B64 }}
      - name: Deploy all wrangler-config workers
        run: |
          export PATH="$HOME/npm-global/bin:$HOME/bin:$PATH"
          if ! command -v wrangler >/dev/null 2>&1; then
            echo "âš ï¸ wrangler not available"; exit 0
          fi
          for conf in wrangler-configs/*.toml; do
            name=$(basename "$conf" .toml)
            echo "ðŸš€ Deploying $name..."
            wrangler deploy --config "$conf" 2>/dev/null && echo "âœ… $name" || echo "âš ï¸ $name failed"
          done

  # â”€â”€ Step 7: Memory journal + broadcast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sync-memory:
    name: "ðŸ§  Sync Memory + Broadcast"
    runs-on: [self-hosted, blackroad-fleet]
    needs: [deploy-blackroad-io, deploy-blackroad-os-web, deploy-agents-dashboard]
    if: always()
    steps:
      - uses: actions/checkout@v6
      - name: Restore wrangler auth
        run: |
          if [ -n "$WRANGLER_CONFIG_B64" ]; then
            mkdir -p ~/.wrangler/config
            echo "$WRANGLER_CONFIG_B64" | base64 -d > ~/.wrangler/config/default.toml
            echo "âœ… wrangler auth restored"
          fi
        env:
          WRANGLER_CONFIG_B64: ${{ secrets.WRANGLER_CONFIG_B64 }}
      - name: Log to memory journal
        run: |
          HASH=$(echo -n "deploy-$(date +%s)" | shasum | cut -c1-16)
          cat >> memory/journals/master-journal.jsonl << EOF
          {"hash":"${HASH}","prev":"7855a8419136738a","ts":"$(date -u +%Y-%m-%dT%H:%M:%SZ)","action":"domain-deploy-complete","entity":"all-domains","details":"Deploy complete: blackroad.io, blackroad-os-web, agents-dashboard, lucidia-earth, subdomain-workers. Live data worker deployed. All pulling from blackroad-live-data API.","agent":"CECE/GH-Actions","run":"${{ github.run_id }}"}
          EOF
          echo "âœ… Memory journal updated"
      - name: Push memory update
        run: |
          git config user.name "CECE"
          git config user.email "cece@blackroad.io"
          git add memory/journals/master-journal.jsonl
          git diff --staged --quiet || git commit -m "memory: domain deploy checkpoint [run ${{ github.run_id }}]"
          git push origin HEAD || true
