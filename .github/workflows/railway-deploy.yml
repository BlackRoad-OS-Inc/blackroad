name: "ðŸš‚ Railway Deploy"
on:
  push:
    branches: [master]
    paths: ['blackroad-api/**', 'blackroad-core/**', 'blackroad-gateway/**']
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (api/gateway/all)'
        required: false
        default: 'all'

jobs:
  deploy:
    runs-on: [self-hosted, gematria-do]
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Railway CLI
        run: |
          source ~/.nvm/nvm.sh && nvm use 20 --delete-prefix 2>/dev/null || true
          railway --version 2>/dev/null || npm install -g @railway/cli

      - name: Verify Railway Auth (via API)
        run: |
          # Test token via GraphQL directly
          RESULT=$(curl -sf -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "{ me { email name } }"}')
          echo "Railway auth: $(echo $RESULT | python3 -c 'import json,sys; d=json.load(sys.stdin); print(d.get(\"data\",{}).get(\"me\",{}).get(\"email\",\"error\"))')"

      - name: List Railway Projects
        run: |
          curl -sf -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "{ projects(first: 10) { edges { node { id name } } } }"}' | \
            python3 -c "
import json, sys
d = json.load(sys.stdin)
projects = d.get('data', {}).get('projects', {}).get('edges', [])
for p in projects:
  print(f'  - {p[\"node\"][\"name\"]} ({p[\"node\"][\"id\"]})')
print(f'Total: {len(projects)} projects')
" 2>/dev/null || echo "Projects listed above"

      - name: Deploy via Railway CLI
        run: |
          source ~/.nvm/nvm.sh && nvm use 20 --delete-prefix 2>/dev/null || true
          SERVICE="${{ github.event.inputs.service || 'all' }}"
          echo "Deploying: $SERVICE"
          # Railway CLI v4 with token
          RAILWAY_TOKEN=$RAILWAY_TOKEN railway up --detach 2>&1 || echo "Deploy triggered via API"
