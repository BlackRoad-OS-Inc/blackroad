name: Google Drive Backup
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      direction:
        description: Sync direction (push/pull/both)
        default: push
        required: false
jobs:
  gdrive-sync:
    runs-on: [self-hosted, octavia-pi5]
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Check rclone
        id: rclone-check
        run: |
          if command -v rclone >/dev/null 2>&1; then
            echo "available=true" >> "$GITHUB_OUTPUT"
            rclone version | head -1
            rclone listremotes 2>/dev/null | grep gdrive && echo "gdrive remote configured" || echo "gdrive not configured"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "rclone not installed - install with: sudo apt install rclone"
          fi
      - name: Sync to Google Drive
        if: steps.rclone-check.outputs.available == 'true'
        run: |
          DIRECTION="${{ github.event.inputs.direction || 'push' }}"
          RUNNER=$(hostname)
          echo "Starting $DIRECTION sync from $RUNNER"
          if rclone listremotes 2>/dev/null | grep -q "gdrive-blackroad"; then
            rclone sync /home/pi/blackroad-data gdrive-blackroad:blackroad/pi-$RUNNER --progress --transfers=4 --max-size=100M 2>/dev/null || true
            rclone sync /home/pi/models gdrive-blackroad:blackroad/models --progress --transfers=2 --max-size=500M 2>/dev/null || true
            echo "Sync complete to gdrive-blackroad:blackroad/"
          else
            echo "gdrive-blackroad remote not configured - skipping"
            echo "Configure with: rclone config on octavia"
          fi
      - name: Report sync status
        run: |
          echo "Backup run from $(hostname) at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          df -h / | tail -1
