name: üå©Ô∏è Deploy Cloudflare Workers

on:
  workflow_dispatch:
    inputs:
      worker:
        description: 'Worker to deploy'
        required: false
        default: 'agents'
        type: choice
        options:
          - agents
          - all
  push:
    branches: [master]
    paths:
      - 'blackroad-agents/worker/src/**'

jobs:
  deploy-agents:
    name: üöÄ Deploy blackroad-agents Worker
    runs-on: [self-hosted, blackroad-fleet, octavia]
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: 848cf0b18d51e0170e0d1537aec3505a
    steps:
      - uses: actions/checkout@v6

        with:
          submodules: false
      - name: Build & Deploy agents worker
        working-directory: blackroad-agents/worker
        run: |
          export PATH=$HOME/npm-global/bin:$HOME/bin:$PATH
          node --version && npm --version
          npm install --silent
          wrangler deploy --config wrangler.toml
          echo "‚úÖ blackroad-agents worker deployed"

      - name: Verify deployment
        run: |
          sleep 5
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" https://blackroad-agents.blackroad.workers.dev/health || echo "000")
          echo "Status: $HTTP"
          [ "$HTTP" = "200" ] && echo "‚úÖ Worker live" || echo "‚ö†Ô∏è  Worker returned $HTTP (may still be deploying)"
