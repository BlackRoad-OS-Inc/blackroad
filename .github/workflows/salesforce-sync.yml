name: üîµ Salesforce Sync

on:
  push:
    branches: [master, main]
    paths:
      - 'blackroad-sf/**'
  workflow_dispatch:

jobs:
  sf-deploy:
    name: üöÄ Deploy to Salesforce
    runs-on: [self-hosted, pi, alice]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install SFDX
        run: |
          if ! command -v sf &>/dev/null; then
            npm install -g @salesforce/cli --quiet
          fi
          sf --version

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SF_AUTH_URL }}" | sf org login sfdx-url \
            --sfdx-url-stdin --alias blackroad-org 2>/dev/null || \
          echo "‚ö†Ô∏è SF auth not configured. Add SF_AUTH_URL secret."

      - name: Deploy metadata
        working-directory: blackroad-sf
        run: |
          if sf org display --target-org blackroad-org &>/dev/null; then
            sf project deploy start \
              --source-dir force-app \
              --target-org blackroad-org \
              --wait 10
          else
            echo "‚ö†Ô∏è SF org not authenticated. Skipping deploy."
          fi
        continue-on-error: true

      - name: Notify webhook
        run: |
          curl -s -X POST http://localhost:8444/sync \
            -H 'Content-Type: application/json' \
            -d "{\"type\":\"DeployComplete\",\"sha\":\"${{ github.sha }}\",\"run\":\"${{ github.run_id }}\"}" \
            || true
