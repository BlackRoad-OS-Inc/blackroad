name: Salesforce Full Deploy
on:
  push:
    branches: [master, main]
    paths:
      - 'blackroad-sf/**'
      - 'force-app/**'
  workflow_dispatch:
    inputs:
      target_org:
        description: Target Salesforce Org alias
        default: blackroad-dev
        required: false
      deploy_type:
        description: Deploy type
        default: deploy
        required: false
jobs:
  salesforce-deploy:
    runs-on: [self-hosted, blackroad-fleet]
    timeout-minutes: 60
    env:
      SF_ORG: ${{ github.event.inputs.target_org || 'blackroad-dev' }}
      DEPLOY_TYPE: ${{ github.event.inputs.deploy_type || 'deploy' }}
    steps:
      - uses: actions/checkout@v6

      - name: Check SF CLI
        id: sf-check
        run: |
          if command -v sf >/dev/null 2>&1; then
            echo "sf_available=true" >> "$GITHUB_OUTPUT"
            sf --version
          elif command -v sfdx >/dev/null 2>&1; then
            echo "sf_available=true" >> "$GITHUB_OUTPUT"
            sfdx --version
          else
            echo "sf_available=false" >> "$GITHUB_OUTPUT"
            echo "Salesforce CLI not installed on $(hostname) - installing..."
            npm install -g @salesforce/cli 2>/dev/null || true
            command -v sf >/dev/null && echo "sf_available=true" >> "$GITHUB_OUTPUT" || echo "sf_available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Auth to Salesforce
        if: steps.sf-check.outputs.sf_available == 'true'
        env:
          SF_JWT_KEY: ${{ secrets.SALESFORCE_JWT_KEY }}
          SF_CLIENT_ID: ${{ secrets.SALESFORCE_CLIENT_ID }}
          SF_USERNAME: ${{ secrets.SALESFORCE_USERNAME }}
        run: |
          if [ -z "$SF_JWT_KEY" ]; then
            echo "SALESFORCE_JWT_KEY secret not set - skipping auth"
            exit 0
          fi
          echo "$SF_JWT_KEY" > /tmp/sf-server.key
          chmod 600 /tmp/sf-server.key
          sf org login jwt --username "$SF_USERNAME" --jwt-key-file /tmp/sf-server.key --client-id "$SF_CLIENT_ID" --alias "$SF_ORG" --set-default || true
          rm -f /tmp/sf-server.key
          sf org display --target-org "$SF_ORG" 2>/dev/null || echo "Org auth status unknown"

      - name: Run Apex tests
        if: steps.sf-check.outputs.sf_available == 'true'
        run: |
          cd blackroad-sf 2>/dev/null || true
          if [ -f "package.json" ]; then
            npm test --if-present 2>/dev/null || true
          fi
          echo "Test phase complete"

      - name: Deploy to Salesforce
        if: steps.sf-check.outputs.sf_available == 'true'
        run: |
          if sf org display --target-org "$SF_ORG" >/dev/null 2>&1; then
            echo "Deploying to $SF_ORG"
            sf project deploy start --target-org "$SF_ORG" --ignore-conflicts 2>/dev/null || echo "Deploy attempted"
          else
            echo "No authenticated org found - skipping deployment"
          fi
          echo "Salesforce phase complete on $(hostname)"
