# Configure nginx on Pi fleet from self-hosted runner
# Runs as pi user which has NOPASSWD sudo
name: ðŸ–§ Configure Pi Nginx

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: false
        default: 'reload'

jobs:
  configure-nginx:
    name: ðŸ”§ Configure Nginx
    runs-on: [self-hosted, blackroad-fleet]
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ–§ Write Nginx Config
        run: |
          sudo tee /etc/nginx/conf.d/blackroad-wildcard.conf > /dev/null << 'NGINXEOF'
          map $host $app_backend {
              default                     http://127.0.0.1:8080;
              "~^console\."               http://127.0.0.1:3000;
              "~^dashboard\."             http://127.0.0.1:3000;
              "~^grafana\."               http://127.0.0.1:3001;
              "~^monitoring\."            http://127.0.0.1:9090;
              "~^jupyter\."               http://127.0.0.1:8888;
              "~^ollama\."                http://127.0.0.1:11434;
              "~^models\."                http://127.0.0.1:11434;
              "~^api\."                   http://127.0.0.1:8787;
              "~^agents?\."               http://127.0.0.1:8787;
              "~^gateway\."               http://127.0.0.1:8787;
          }

          server {
              listen 80;
              server_name ~^.+\.blackroad\.(io|ai)$
                          blackroad.network blackroad.systems blackroad.me
                          lucidia.earth lucidia.studio;

              location /health {
                  default_type application/json;
                  return 200 '{"status":"ok","host":"$hostname","tunnel":"52915859","models":108}';
              }

              location / {
                  proxy_pass $app_backend;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-Proto https;
                  proxy_connect_timeout 10s;
                  proxy_read_timeout 120s;
              }
          }
          NGINXEOF

      - name: âœ… Reload Nginx
        run: |
          sudo nginx -t && sudo systemctl reload nginx
          echo "âœ… Nginx reloaded at $(date -u)"
          curl -s http://localhost/health || echo "health check pending"

      - name: ðŸ”„ Ensure Cloudflare Tunnel Running
        run: |
          sudo systemctl status cloudflared | head -5 || true
          sudo systemctl is-active cloudflared && echo "âœ… Tunnel active" || sudo systemctl start cloudflared
