# Fleet Diag Cleanup â€” prevents disk fill from runner diagnostic logs
# Runs on every self-hosted runner, deletes logs older than 1 day
name: "ðŸ§¹ Fleet Diag Cleanup"

on:
  schedule:
    - cron: '0 4 * * *'   # 4 AM UTC daily (all nodes)
  workflow_dispatch:

jobs:
  cleanup-alice:
    name: "ðŸ§¹ alice"
    runs-on: [self-hosted, alice-pi]
    continue-on-error: true
    steps:
      - name: Clean diag logs
        run: |
          DIAG=~/actions-runner/_diag
          BEFORE=$(du -sh "$DIAG" 2>/dev/null | cut -f1)
          find "$DIAG" -name "*.log" -mtime +1 -delete 2>/dev/null || true
          AFTER=$(du -sh "$DIAG" 2>/dev/null | cut -f1)
          echo "$(hostname): $BEFORE â†’ $AFTER ($(df -h / | tail -1 | awk '{print $5}') disk used)"

  cleanup-aria:
    name: "ðŸ§¹ aria"
    runs-on: [self-hosted, aria-pi4]
    continue-on-error: true
    steps:
      - name: Clean diag logs
        run: |
          DIAG=~/actions-runner/_diag
          BEFORE=$(du -sh "$DIAG" 2>/dev/null | cut -f1)
          find "$DIAG" -name "*.log" -mtime +1 -delete 2>/dev/null || true
          AFTER=$(du -sh "$DIAG" 2>/dev/null | cut -f1)
          echo "$(hostname): $BEFORE â†’ $AFTER ($(df -h / | tail -1 | awk '{print $5}') disk used)"

  cleanup-octavia:
    name: "ðŸ§¹ octavia"
    runs-on: [self-hosted, octavia-pi5]
    continue-on-error: true
    steps:
      - name: Clean diag logs
        run: |
          DIAG=~/actions-runner/_diag
          find "$DIAG" -name "*.log" -mtime +1 -delete 2>/dev/null || true
          echo "$(hostname): $(df -h / | tail -1 | awk '{print $5}') disk used"

  cleanup-cecilia:
    name: "ðŸ§¹ cecilia"
    runs-on: [self-hosted, cecilia]
    continue-on-error: true
    steps:
      - name: Clean diag logs
        run: |
          DIAG=~/actions-runner/_diag
          find "$DIAG" -name "*.log" -mtime +1 -delete 2>/dev/null || true
          echo "$(hostname): $(df -h / | tail -1 | awk '{print $5}') disk used"

  cleanup-lucidia:
    name: "ðŸ§¹ lucidia"
    runs-on: [self-hosted, lucidia-pi5]
    continue-on-error: true
    steps:
      - name: Clean diag logs
        run: |
          DIAG=~/actions-runner/_diag
          find "$DIAG" -name "*.log" -mtime +1 -delete 2>/dev/null || true
          echo "$(hostname): $(df -h / | tail -1 | awk '{print $5}') disk used"

  cleanup-gematria:
    name: "ðŸ§¹ gematria"
    runs-on: [self-hosted, gematria-do]
    continue-on-error: true
    steps:
      - name: Clean diag logs + old workspace
        run: |
          DIAG=~/actions-runner/_diag
          BEFORE=$(du -sh "$DIAG" 2>/dev/null | cut -f1)
          find "$DIAG" -name "*.log" -mtime +1 -delete 2>/dev/null || true
          # Also clear old temp workspace dirs > 7 days
          find ~/actions-runner/_work/_temp -maxdepth 1 -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
          AFTER=$(du -sh "$DIAG" 2>/dev/null | cut -f1)
          echo "$(hostname): $BEFORE â†’ $AFTER ($(df -h / | tail -1 | awk '{print $5}') disk used)"

  cleanup-anastasia:
    name: "ðŸ§¹ anastasia"
    runs-on: [self-hosted, anastasia]
    continue-on-error: true
    steps:
      - name: Clean diag logs
        run: |
          DIAG=~/actions-runner/_diag
          find "$DIAG" -name "*.log" -mtime +1 -delete 2>/dev/null || true
          echo "$(hostname): $(df -h / | tail -1 | awk '{print $5}') disk used"
