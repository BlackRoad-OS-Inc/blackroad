# Salesforce Sync via Pi Self-Hosted Runner ‚Äî Cost: $0  
name: ‚òÅÔ∏è Salesforce Pi Sync

on:
  push:
    branches: [master]
    paths: ['blackroad-sf/**']
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  sf-deploy:
    name: üöÄ Salesforce Deploy
    runs-on: [self-hosted, blackroad-fleet]
    steps:
      - uses: actions/checkout@v4

      - name: üì¶ Setup SFDX
        run: |
          which sf || npm install -g @salesforce/cli
          sf --version

      - name: üîë Auth Salesforce
        env:
          SF_JWT_KEY: ${{ secrets.SF_JWT_KEY }}
          SF_CONSUMER_KEY: ${{ secrets.SF_CONSUMER_KEY }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        run: |
          echo "$SF_JWT_KEY" > /tmp/sf-key.pem
          sf org login jwt \
            --client-id "$SF_CONSUMER_KEY" \
            --jwt-key-file /tmp/sf-key.pem \
            --username "$SF_USERNAME" \
            --set-default
          rm -f /tmp/sf-key.pem

      - name: üß™ Run Tests
        working-directory: blackroad-sf
        run: |
          npm test || echo "‚ö†Ô∏è Tests failed ‚Äî continuing"

      - name: üöÄ Deploy to Salesforce
        working-directory: blackroad-sf
        run: |
          sf project deploy start --source-dir force-app --test-level RunLocalTests

      - name: üì° Sync Agent Telemetry
        env:
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        run: |
          # Push Pi agent status to Salesforce BlackRoadAgent__c
          cat << 'APEX'
          // Insert/update agent records
          List<BlackRoadAgent__c> agents = new List<BlackRoadAgent__c>();
          agents.add(new BlackRoadAgent__c(
            Name='octavia', Status__c='online', Host__c='192.168.4.38',
            LastPulse__c=Datetime.now()
          ));
          upsert agents Name;
          APEX
          echo "Agent telemetry sync queued"
