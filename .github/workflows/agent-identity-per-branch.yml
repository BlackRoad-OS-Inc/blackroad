name: Agent Identity Per Branch
on:
  create:
  push:
    branches-ignore:
      - master
      - main
jobs:
  assign-identity:
    runs-on: [self-hosted, blackroad-fleet]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6
      - name: Assign agent identity to branch
        run: |
          BRANCH="${GITHUB_REF_NAME:-unknown}"
          if echo "$BRANCH" | grep -qi "^feat/"; then AGENT="aria"; ROLE="frontend"
          elif echo "$BRANCH" | grep -qi "^fix/\|^bug/"; then AGENT="alice"; ROLE="debugger"
          elif echo "$BRANCH" | grep -qi "^infra/\|^deploy/"; then AGENT="octavia"; ROLE="infra"
          elif echo "$BRANCH" | grep -qi "^sec/\|^security/"; then AGENT="shellfish"; ROLE="security"
          elif echo "$BRANCH" | grep -qi "^ai/\|^ml/"; then AGENT="lucidia"; ROLE="ai"
          elif echo "$BRANCH" | grep -qi "^sf/\|^salesforce/"; then AGENT="alice"; ROLE="salesforce"
          else AGENT="cece"; ROLE="general"; fi
          mkdir -p .blackroad
          COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo unknown)
          RUNNER=$(hostname)
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          printf '{"branch":"%s","agent":"%s","role":"%s","runner":"%s","assigned_at":"%s","commit":"%s"}\n' "$BRANCH" "$AGENT" "$ROLE" "$RUNNER" "$TIMESTAMP" "$COMMIT" > .blackroad/agent-identity.json
          cat .blackroad/agent-identity.json
          git config user.email "actions@blackroad.io"
          git config user.name "BlackRoad Actions"
          git add .blackroad/agent-identity.json
          git diff --staged --quiet || git commit -m "chore: assign $AGENT to $BRANCH [skip ci]" && git push origin HEAD || true
