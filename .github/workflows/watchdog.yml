# Watchdog: Ensures continuous orchestrator never dies
name: "üëÅÔ∏è Watchdog"

on:
  schedule:
    - cron: '0 6 * * *'   # 6 AM daily ‚Äî checks if midnight run happened
  workflow_dispatch:

jobs:
  check-and-restart:
    runs-on: [self-hosted, blackroad-fleet]
    steps:
      - name: Check last orchestrator run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LAST=$(gh run list --workflow continuous-24h-orchestrator.yml \
            --repo ${{ github.repository }} \
            --limit 1 \
            --json createdAt,conclusion \
            --jq '.[0] | "\(.conclusion) at \(.createdAt)"' 2>/dev/null || echo "unknown")
          echo "Last orchestrator run: $LAST"
          
          # If last run was >25 hours ago or failed, trigger a new one
          if echo "$LAST" | grep -qiE "failure|cancelled|unknown"; then
            echo "‚ö†Ô∏è Last run had issues ‚Äî re-triggering..."
            sleep 3
            gh workflow run continuous-24h-orchestrator.yml \
              --repo ${{ github.repository }} -f force_cycle=true
            echo "‚úÖ Orchestrator re-triggered"
          else
            echo "‚úÖ Orchestrator healthy"
          fi
