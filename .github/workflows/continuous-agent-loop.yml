# BlackRoad OS â€” Continuous Agent Loop
# Runs 24/7 on self-hosted Pi runners. Cost: $0.
# Strategy: runs for 23h 55m then self-triggers to restart.
# "Fails" intentionally at 24h+3s to force a clean restart cycle.

name: ðŸ”„ Continuous Agent Loop

on:
  workflow_dispatch:
    inputs:
      cycle:
        description: 'Cycle number'
        required: false
        default: '1'
      agent:
        description: 'Agent to run'
        required: false
        default: 'octavia'
  schedule:
    # Boot cycle â€” triggers at midnight UTC daily as backup
    - cron: '0 0 * * *'

concurrency:
  group: continuous-loop-${{ github.event.inputs.agent || 'octavia' }}
  cancel-in-progress: false

jobs:
  agent-loop:
    name: ðŸ¤– Agent Loop (Cycle ${{ github.event.inputs.cycle || '1' }})
    runs-on: [self-hosted, blackroad-fleet]
    timeout-minutes: 1440  # 24 hours max
    
    steps:
      - name: ðŸ” Cycle Start
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  BLACKROAD AGENT LOOP"
          echo "  Agent  : ${{ github.event.inputs.agent || 'octavia' }}"
          echo "  Cycle  : ${{ github.event.inputs.cycle || '1' }}"
          echo "  Started: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "  Runner : $(hostname)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ“¡ Sync Repo
        run: |
          cd ~/blackroad 2>/dev/null || git clone https://github.com/BlackRoad-OS-Inc/blackroad.git ~/blackroad
          cd ~/blackroad && git fetch origin master --quiet && git reset --hard origin/master

      - name: ðŸ”‹ Agent Health Pulse
        run: |
          # Every 5 minutes for 23h 50m = 286 iterations
          AGENT="${{ github.event.inputs.agent || 'octavia' }}"
          CYCLES=286
          INTERVAL=300  # 5 minutes
          
          for i in $(seq 1 $CYCLES); do
            TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            echo "[$TIMESTAMP] ðŸ’“ $AGENT pulse #$i/$CYCLES"
            
            # Run agent tasks if available
            if [ -f ~/blackroad/tools/agent-tasks/br-agent-tasks.sh ]; then
              ~/blackroad/tools/agent-tasks/br-agent-tasks.sh process "$AGENT" 2>/dev/null || true
            fi
            
            # Check for new workflow dispatches
            sleep $INTERVAL
          done

      - name: ðŸ”„ Self-Trigger Next Cycle
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_CYCLE=$(( ${{ github.event.inputs.cycle || '1' }} + 1 ))
          AGENT="${{ github.event.inputs.agent || 'octavia' }}"
          echo "Triggering cycle $NEXT_CYCLE for $AGENT..."
          
          # Self-trigger via workflow_dispatch
          curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/continuous-agent-loop.yml/dispatches" \
            -d "{\"ref\":\"master\",\"inputs\":{\"cycle\":\"$NEXT_CYCLE\",\"agent\":\"$AGENT\"}}" \
            && echo "âœ… Cycle $NEXT_CYCLE triggered" \
            || echo "âš ï¸ Self-trigger failed â€” cron will restart"

      - name: ðŸ“ Log Cycle Complete
        if: always()
        run: |
          echo "Cycle ${{ github.event.inputs.cycle || '1' }} complete at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          # Log to journal
          echo "{\"ts\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"action\":\"cycle-complete\",\"agent\":\"${{ github.event.inputs.agent }}\",\"cycle\":${{ github.event.inputs.cycle || 1 }}}" \
            >> ~/blackroad/memory/journals/master-journal.jsonl 2>/dev/null || true
