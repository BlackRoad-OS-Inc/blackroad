name: âš¡ Continuous Runner (24h Self-Hosted â€” $0)

on:
  workflow_dispatch:
    inputs:
      relay_count:
        description: 'Relay iteration count'
        required: false
        default: '0'
  schedule:
    - cron: '0 0 * * *'  # Midnight UTC daily bootstrap (in case chain breaks)

concurrency:
  group: continuous-runner
  cancel-in-progress: false

jobs:
  # â”€â”€â”€ RELAY TRIGGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Fires 3 seconds before the main job would expire, chaining the next run
  relay:
    name: ğŸ” Relay â€” Chain Next Run
    runs-on: [self-hosted, pi, cecilia]
    timeout-minutes: 1
    steps:
      - name: Schedule next run (fires at T+3s before main expires)
        run: |
          NEXT_COUNT=$(( ${{ github.event.inputs.relay_count || 0 }} + 1 ))
          echo "ğŸ” Chaining run #$NEXT_COUNT"
          # Sleep until 3s before the main job expires (1440min - 1min relay = 1439min)
          sleep 86340  # 23h 59m â€” then trigger next
          gh workflow run continuous-runner.yml \
            --repo ${{ github.repository }} \
            -f relay_count=$NEXT_COUNT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€ MAIN LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  main-loop:
    name: ğŸš€ Main Loop â€” Always Running
    runs-on: [self-hosted, pi]
    timeout-minutes: 1440  # 24 hours (self-hosted runner â€” $0 billable)
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ§  Init agent context
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš¡ BLACKROAD CONTINUOUS RUNNER"
          echo "   Run #${{ github.event.inputs.relay_count || 0 }}"
          echo "   Node: $(hostname) | $(date -u)"
          echo "   Billable time: \$0 (self-hosted)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          # Write to memory journal
          mkdir -p memory/journals
          echo "{\"ts\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"action\":\"continuous-start\",\"run\":\"${{ github.run_id }}\",\"relay\":\"${{ github.event.inputs.relay_count || 0 }}\",\"node\":\"$(hostname)\",\"billable\":0}" \
            >> memory/journals/master-journal.jsonl || true

      - name: ğŸ¥ Fleet health check
        run: |
          for node in 192.168.4.89 192.168.4.82 192.168.4.38 192.168.4.49; do
            ping -c 1 -W 2 $node >/dev/null 2>&1 && echo "âœ… $node" || echo "âŒ $node"
          done

      - name: ğŸŒ Domain health check
        run: |
          for domain in blackroad.io blackroad.network blackroad.systems lucidia.earth; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://$domain" 2>/dev/null || echo "000")
            echo "$STATUS $domain"
          done

      - name: ğŸ”„ Sync coordination state
        run: |
          # Update collab status on all Pis
          for node in cecilia aria octavia alice; do
            ssh -o ConnectTimeout=3 -o BatchMode=yes $node \
              "echo '{\"ping\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"run\":\"${{ github.run_id }}\"}' \
               > ~/.blackroad/sessions/last-github-ping.json" 2>/dev/null || true
          done

      - name: ğŸ¤– Run agent tasks
        run: |
          # Process any pending tasks from the task marketplace
          if [ -d ~/.blackroad/tasks/available ]; then
            TASKS=$(ls ~/.blackroad/tasks/available/ 2>/dev/null | wc -l)
            echo "ğŸ“‹ Available tasks: $TASKS"
          fi

      - name: ğŸ’¤ Continuous idle loop (runs until 24h timeout)
        run: |
          # Stay alive â€” check every 60 minutes
          END_TIME=$(( $(date +%s) + 86340 ))  # 23h 59min
          while [ $(date +%s) -lt $END_TIME ]; do
            echo "[$(date -u +%H:%M:%S)] â™¥ alive â€” run #${{ github.event.inputs.relay_count || 0 }}"
            sleep 3600  # heartbeat every 1 hour
          done
          echo "ğŸ” Approaching 24h limit â€” relay will chain next run"
