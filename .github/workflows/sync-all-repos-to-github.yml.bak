name: ðŸ”„ Sync All Repos to BlackRoad-OS GitHub

on:
  workflow_dispatch:
    inputs:
      org:
        description: 'Target org'
        required: false
        default: 'BlackRoad-OS'
      visibility:
        description: 'Repo visibility'
        required: false
        default: 'public'
        type: choice
        options: [public, private]
  schedule:
    - cron: '0 2 * * *'  # Daily 2am UTC

jobs:
  sync-orgs-core:
    name: ðŸ“¦ Sync orgs/core â†’ BlackRoad-OS
    runs-on: [self-hosted, blackroad-fleet]
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TARGET_ORG: ${{ github.event.inputs.org || 'BlackRoad-OS' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Sync all orgs/core repos
        run: |
          CREATED=0; UPDATED=0; FAILED=0
          
          for dir in orgs/core/*/; do
            [ -d "$dir/.git" ] || continue
            name=$(basename "$dir")
            
            echo "  ðŸ“¦ $name"
            
            # Ensure git remote
            cd "$dir"
            REMOTE="https://x-access-token:$GH_TOKEN@github.com/$TARGET_ORG/$name.git"
            git remote set-url origin "$REMOTE" 2>/dev/null || git remote add origin "$REMOTE" 2>/dev/null || true
            
            # Create repo if missing
            gh repo create "$TARGET_ORG/$name" --public --description "BlackRoad OS: $name" 2>/dev/null && CREATED=$((CREATED+1)) || true
            
            # Push
            git push origin HEAD:main --force 2>/dev/null && UPDATED=$((UPDATED+1)) \
              || git push origin HEAD:master --force 2>/dev/null && UPDATED=$((UPDATED+1)) \
              || { echo "  âš ï¸ push failed: $name"; FAILED=$((FAILED+1)); }
            
            cd $GITHUB_WORKSPACE
          done
          
          echo ""
          echo "ðŸ“Š orgs/core sync: âœ… $CREATED created | ðŸ”„ $UPDATED updated | âŒ $FAILED failed"

      - name: Sync orgs/ai repos
        run: |
          SYNCED=0; FAILED=0
          for dir in orgs/ai/*/; do
            [ -d "$dir/.git" ] || continue
            name=$(basename "$dir")
            cd "$dir"
            REMOTE="https://x-access-token:$GH_TOKEN@github.com/BlackRoad-AI/$name.git"
            git remote set-url origin "$REMOTE" 2>/dev/null || git remote add origin "$REMOTE" 2>/dev/null || true
            gh repo create "BlackRoad-AI/$name" --public 2>/dev/null || true
            git push origin HEAD:main --force 2>/dev/null && SYNCED=$((SYNCED+1)) || FAILED=$((FAILED+1))
            cd $GITHUB_WORKSPACE
          done
          echo "ðŸ“Š orgs/ai sync: âœ… $SYNCED synced | âŒ $FAILED failed"

      - name: Sync main blackroad repo to BlackRoad-OS-Inc
        run: |
          echo "  ðŸ“¦ Syncing main blackroad repo..."
          REMOTE="https://x-access-token:$GH_TOKEN@github.com/BlackRoad-OS-Inc/blackroad.git"
          git remote set-url blackroad-inc "$REMOTE" 2>/dev/null || git remote add blackroad-inc "$REMOTE" 2>/dev/null || true
          git push blackroad-inc HEAD:main --force 2>/dev/null || git push blackroad-inc HEAD:master --force 2>/dev/null || echo "  âš ï¸ main repo sync failed"
          echo "  âœ… Main repo synced"

      - name: Log sync to memory
        run: |
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "{\"ts\":\"$TS\",\"type\":\"sync\",\"entity\":\"github-repos\",\"detail\":\"Full sync of all orgs to BlackRoad-OS GitHub\",\"agent\":\"alice\"}" \
            >> memory/journals/master-journal.jsonl || true
          git add memory/journals/master-journal.jsonl 2>/dev/null || true
          git diff --cached --quiet || git commit -m "chore: sync memory log [skip ci]

Co-authored-by: Copilot <223556219+Copilot@users.noreply.github.com>" || true
          git push origin HEAD:master 2>/dev/null || true
