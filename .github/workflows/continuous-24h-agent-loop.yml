name: ğŸ”„ Continuous 24h Agent Loop
# Self-hosted Pi runners = $0 cost, no time limits
# Chains itself: runs 24h, triggers next run 3 seconds before completing

on:
  schedule:
    - cron: '3 0 * * *'    # Daily at 00:03 UTC (bootstrap)
  workflow_dispatch:
    inputs:
      agent:
        description: 'Which agent to run'
        required: false
        default: 'BLACKROAD'
        type: choice
        options: [BLACKROAD, CECE, OCTAVIA, ALICE, ARIA, LUCIDIA, GEMATRIA]
  workflow_run:
    workflows: ["ğŸ”„ Continuous 24h Agent Loop"]
    types: [completed]

concurrency:
  group: continuous-agent-loop
  cancel-in-progress: false

jobs:
  # â”€â”€ 3-second heartbeat (triggers chain continuation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  heartbeat:
    name: ğŸ’“ 3s Heartbeat
    runs-on: [self-hosted, pi]
    timeout-minutes: 1
    outputs:
      session_id: ${{ steps.init.outputs.session_id }}
    steps:
      - uses: actions/checkout@v4

      - name: Init session
        id: init
        run: |
          SESSION="$(date -u +%Y%m%d-%H%M%S)-$$"
          echo "session_id=${SESSION}" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Session: ${SESSION}"
          sleep 3

      - name: Load agent identity
        run: |
          BRANCH="${{ github.ref_name }}"
          AGENT_FILE=".agents/${BRANCH}.json"
          if [ -f "$AGENT_FILE" ]; then
            cat "$AGENT_FILE"
          else
            ./scripts/branch-agent-identity.sh "${BRANCH}" 2>/dev/null || true
          fi

  # â”€â”€ 24h agent cycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  agent-cycle:
    name: ğŸ¤– 24h Agent Cycle
    runs-on: [self-hosted, pi]
    needs: heartbeat
    timeout-minutes: 1440   # 24 hours (only enforced on GitHub-hosted)
    steps:
      - uses: actions/checkout@v4

      - name: Health check all platforms
        run: |
          echo "ğŸ” Checking platform health..."
          curl -sf https://api.cloudflare.com/client/v4/user/tokens/verify \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" | \
            python3 -c "import sys,json; d=json.load(sys.stdin); print('CF:', d.get('result',{}).get('status','unknown'))" 2>/dev/null || echo "CF: skipped"
          curl -sf https://railway.app/api/healthz 2>/dev/null && echo "Railway: ok" || echo "Railway: skipped"

      - name: Run Pi agent sync
        run: |
          echo "ğŸ¤– Agent: ${{ github.event.inputs.agent || 'BLACKROAD' }}"
          echo "ğŸ“¡ Session: ${{ needs.heartbeat.outputs.session_id }}"
          # Source agent-specific scripts if they exist
          AGENT="${{ github.event.inputs.agent || 'BLACKROAD' }}"
          SCRIPT="scripts/agents/${AGENT,,}-cycle.sh"
          if [ -f "$SCRIPT" ]; then
            bash "$SCRIPT"
          else
            echo "âœ… Agent cycle: monitoring active"
            sleep 60  # 1-minute default idle cycle
          fi

      - name: Sync memory
        if: always()
        run: |
          # Write cycle completion to memory
          echo '{"cycle": "complete", "time": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' >> \
            ~/.blackroad/memory/journals/master-journal.jsonl 2>/dev/null || true

  # â”€â”€ Self-continuation trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  continue-loop:
    name: ğŸ” Queue Next Run
    runs-on: [self-hosted, pi]
    needs: [heartbeat, agent-cycle]
    if: always()
    steps:
      - name: Trigger next 24h cycle
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: continuous-24h-agent-loop.yml
          token: ${{ secrets.GITHUB_TOKEN }}
          inputs: '{"agent": "${{ github.event.inputs.agent || ''BLACKROAD'' }}"}'
        continue-on-error: true

      - name: Log cycle
        run: |
          echo "âœ… Cycle complete. Next run queued."
          echo "ğŸ“Š Total uptime: continuous"
