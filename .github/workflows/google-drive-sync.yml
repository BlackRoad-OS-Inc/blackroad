# Google Drive Sync via rclone on Pi fleet
# Syncs critical BlackRoad files to Google Drive every 24h
# Cost: $0 â€” runs on self-hosted Pi runner
name: "â˜ï¸ Google Drive Sync"

on:
  schedule:
    - cron: '0 6 * * *'   # 6 AM UTC daily
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Full sync (not incremental)'
        type: boolean
        default: false

concurrency:
  group: gdrive-sync
  cancel-in-progress: true

jobs:
  sync-to-drive:
    name: "ğŸ“ Sync to Google Drive"
    runs-on: [self-hosted, blackroad-fleet]
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Check rclone installed
        run: |
          which rclone && rclone --version | head -1 || {
            echo "Installing rclone..."
            curl -fsSL https://rclone.org/install.sh | sudo bash 2>/dev/null || \
            sudo apt-get install -y rclone 2>/dev/null || \
            echo "âš ï¸ rclone not installed â€” configure manually"
          }

      - name: Configure rclone (if token exists)
        env:
          RCLONE_GDRIVE_TOKEN: ${{ secrets.RCLONE_GDRIVE_TOKEN }}
          RCLONE_GDRIVE_CLIENT_ID: ${{ secrets.RCLONE_GDRIVE_CLIENT_ID }}
          RCLONE_GDRIVE_CLIENT_SECRET: ${{ secrets.RCLONE_GDRIVE_CLIENT_SECRET }}
        run: |
          # Write rclone config if secrets available
          if [ -n "$RCLONE_GDRIVE_TOKEN" ]; then
            mkdir -p ~/.config/rclone
            cat > ~/.config/rclone/rclone.conf << EOF
          [gdrive]
          type = drive
          client_id = ${RCLONE_GDRIVE_CLIENT_ID}
          client_secret = ${RCLONE_GDRIVE_CLIENT_SECRET}
          token = ${RCLONE_GDRIVE_TOKEN}
          team_drive =
          EOF
            echo "âœ“ rclone configured"
          else
            echo "âš ï¸ No RCLONE_GDRIVE_TOKEN â€” using existing ~/.config/rclone/rclone.conf"
          fi

      - name: Sync memory/ to Google Drive
        run: |
          rclone sync memory/ gdrive:BlackRoad/memory/ \
            --exclude ".git/**" \
            --progress --stats-one-line \
            2>/dev/null && echo "âœ“ memory synced" || echo "âš ï¸ memory sync failed"
        continue-on-error: true

      - name: Sync agents/ to Google Drive
        run: |
          rclone sync agents/ gdrive:BlackRoad/agents/ \
            --exclude ".git/**" \
            --progress --stats-one-line \
            2>/dev/null && echo "âœ“ agents synced" || echo "âš ï¸ agents sync failed"
        continue-on-error: true

      - name: Sync coordination/ to Google Drive
        run: |
          rclone sync coordination/ gdrive:BlackRoad/coordination/ \
            --exclude ".git/**" \
            --progress --stats-one-line \
            2>/dev/null && echo "âœ“ coordination synced" || echo "âš ï¸ coordination sync failed"
        continue-on-error: true

      - name: Sync tools/ to Google Drive
        run: |
          rclone sync tools/ gdrive:BlackRoad/tools/ \
            --exclude ".git/**" --exclude "node_modules/**" \
            --progress --stats-one-line \
            2>/dev/null && echo "âœ“ tools synced" || echo "âš ï¸ tools sync failed"
        continue-on-error: true

      - name: Sync blackroad-sf/ to Google Drive
        run: |
          rclone sync blackroad-sf/ gdrive:BlackRoad/blackroad-sf/ \
            --exclude ".git/**" --exclude "node_modules/**" \
            --progress --stats-one-line \
            2>/dev/null && echo "âœ“ blackroad-sf synced" || echo "âš ï¸ sf sync failed"
        continue-on-error: true

      - name: Sync docs/ to Google Drive
        run: |
          rclone sync docs/ gdrive:BlackRoad/docs/ \
            2>/dev/null && echo "âœ“ docs synced" || true
          # Also sync root markdown files
          for f in *.md; do
            rclone copy "$f" gdrive:BlackRoad/root-docs/ 2>/dev/null || true
          done
          echo "âœ“ docs synced"
        continue-on-error: true

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜ï¸  Google Drive Sync Complete: $(date -u)"
          echo "ğŸ“ Destination: gdrive:BlackRoad/"
          echo "ğŸ“‚ Synced: memory, agents, coordination, tools, sf, docs"
          echo "ğŸ”’ Excluded: .git, node_modules, vault (secrets stay local)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Re-queue in 24h+3s
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.full_sync == 'true'
        run: |
          sleep 86400
          sleep 3
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/google-drive-sync.yml/dispatches" \
            -d '{"ref":"master"}' && echo "âœ… Next sync queued" || true
