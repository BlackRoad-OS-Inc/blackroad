name: "ðŸš‚ Railway Integration"
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action (status/deploy/list)'
        default: 'status'
        type: choice
        options: [status, list, deploy]
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours

jobs:
  railway:
    runs-on: [self-hosted, gematria-do]
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: false

      - name: Railway Status
        run: |
          RESULT=$(curl -sf -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query": "{ me { email } projects(first: 20) { edges { node { id name updatedAt } } } }"}')
          
          EMAIL=$(echo $RESULT | python3 -c "import json,sys; d=json.load(sys.stdin); print(d['data']['me']['email'])")
          echo "âœ… Railway auth: $EMAIL"
          
          echo "ðŸ“‹ Projects:"
          echo $RESULT | python3 -m json.tool 2>/dev/null | head -20 || true

      - name: Deploy blackroad-api to Railway
        if: github.event.inputs.action == 'deploy'
        run: |
          source ~/.nvm/nvm.sh && nvm use 20 --delete-prefix 2>/dev/null || true
          RAILWAY_TOKEN=${{ secrets.RAILWAY_TOKEN }} railway up \
            --service blackroad-api 2>&1 || echo "Deploy queued via Railway"
