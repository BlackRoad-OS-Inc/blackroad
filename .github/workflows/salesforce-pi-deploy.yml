# SALESFORCE + PI CI/CD PIPELINE
# Pi agents monitor and deploy Salesforce orgs
# Runs on Pi self-hosted runners when available, falls back to GitHub-hosted

name: "â˜ï¸ Salesforce Deploy (Pi-Powered)"

on:
  push:
    branches: [main, develop, 'salesforce/**', 'sf/**']
    paths:
      - 'blackroad-sf/**'
      - 'force-app/**'
      - '**.cls'
      - '**.trigger'
      - '**.lwc/**'
  workflow_dispatch:
    inputs:
      target_org:
        description: 'Salesforce target org'
        required: true
        default: 'production'
        type: choice
        options: [production, sandbox, scratch]
      deploy_mode:
        description: 'Deploy mode'
        required: false
        default: 'check'
        type: choice
        options: [check, deploy, quick-deploy]

jobs:
  # Run tests on Pi (free compute) or fallback to GitHub
  test:
    name: "ðŸ§ª LWC Unit Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: blackroad-sf/package-lock.json

      - name: Install dependencies
        working-directory: blackroad-sf
        run: npm ci
        
      - name: Run LWC tests
        working-directory: blackroad-sf
        run: npm test
        
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: lwc-coverage
          path: blackroad-sf/coverage/

  deploy:
    name: "ðŸš€ Deploy to Salesforce"
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: salesforce-${{ inputs.target_org || 'production' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Salesforce CLI
        run: npm install -g @salesforce/cli
        
      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SALESFORCE_JWT_KEY }}" > /tmp/server.key
          sf org login jwt \
            --client-id "${{ secrets.SALESFORCE_CLIENT_ID }}" \
            --jwt-key-file /tmp/server.key \
            --username "${{ secrets.SALESFORCE_USERNAME }}" \
            --instance-url "${{ secrets.SALESFORCE_INSTANCE_URL }}" \
            --alias target-org
        
      - name: Validate deployment
        if: inputs.deploy_mode == 'check' || inputs.deploy_mode == ''
        working-directory: blackroad-sf
        run: |
          sf project deploy validate \
            --source-dir force-app \
            --target-org target-org \
            --test-level RunLocalTests
          
      - name: Deploy to Salesforce
        if: inputs.deploy_mode == 'deploy' || github.ref == 'refs/heads/main'
        working-directory: blackroad-sf
        run: |
          sf project deploy start \
            --source-dir force-app \
            --target-org target-org \
            --test-level RunLocalTests
            
      - name: Notify Pi fleet of deploy
        run: |
          curl -sf "https://blackroad.io/api/deploy-notify" \
            -H "Content-Type: application/json" \
            -d "{\"service\":\"salesforce\",\"status\":\"deployed\",\"ts\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" \
            2>/dev/null || true
