name: On Release â†’ Multi-Cloud Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: false
        default: 'latest'

jobs:
  deploy-railway:
    runs-on: [self-hosted, pi]
    steps:
      - uses: actions/checkout@v4
        with: { submodules: false }
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          VERSION="${{ github.event.release.tag_name || github.event.inputs.version }}"
          echo "Deploying $VERSION to Railway..."
          command -v railway && railway up || echo "Railway CLI not available"

  deploy-cloudflare:
    runs-on: [self-hosted, pi]
    needs: deploy-railway
    steps:
      - uses: actions/checkout@v4
        with: { submodules: false }
      - name: Deploy CF Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          for cfg in wrangler-configs/*.toml; do
            wrangler deploy --config "$cfg" 2>/dev/null || true
          done

  notify-fleet:
    runs-on: [self-hosted, pi]
    needs: [deploy-railway, deploy-cloudflare]
    steps:
      - name: Broadcast to Pi fleet
        run: |
          VERSION="${{ github.event.release.tag_name || 'latest' }}"
          for pi in 192.168.4.89 192.168.4.82 192.168.4.38 192.168.4.49; do
            ssh -o ConnectTimeout=3 -o StrictHostKeyChecking=no pi@$pi \
              "echo 'Deployed $VERSION' >> ~/deployments.log" 2>/dev/null || true
          done
