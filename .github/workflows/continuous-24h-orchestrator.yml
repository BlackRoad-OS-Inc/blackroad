# ============================================================
# BlackRoad Continuous 24h+3s Orchestrator
# Runs forever: each cycle is 24h, retries after 3s on failure
# Uses self-hosted Pi runners = $0 cost
# ============================================================
name: "â™¾ï¸ Continuous 24h Orchestrator"

on:
  schedule:
    - cron: '0 0 * * *'  # Every 24 hours at midnight UTC
  workflow_dispatch:
    inputs:
      force_cycle:
        description: 'Force immediate cycle'
        type: boolean
        default: false
  workflow_run:
    workflows: ["â™¾ï¸ Continuous 24h Orchestrator"]
    types: [completed]  # Re-queue self on completion

concurrency:
  group: continuous-orchestrator
  cancel-in-progress: false

jobs:
  # â”€â”€ Phase 1: Health Check (3s retry on fail) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  health-check:
    name: "ğŸ¥ Fleet Health Check"
    runs-on: [self-hosted, pi, blackroad]
    timeout-minutes: 5
    outputs:
      fleet_status: ${{ steps.check.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - name: Check Pi Fleet
        id: check
        run: |
          echo "status=healthy" >> $GITHUB_OUTPUT
          curl -sf http://192.168.4.38:4010/health && echo "octavia-pi: âœ…" || echo "octavia-pi: âš ï¸"
          curl -sf http://192.168.4.64:11434/api/tags && echo "lucidia-pi ollama: âœ…" || echo "lucidia-pi: âš ï¸"
        continue-on-error: true

  # â”€â”€ Phase 2: Salesforce Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  salesforce-sync:
    name: "â˜ï¸ Salesforce Sync"
    runs-on: [self-hosted, pi, blackroad]
    needs: health-check
    steps:
      - uses: actions/checkout@v4
      - name: Sync SF metadata
        run: |
          cd blackroad-sf && npm ci --silent 2>/dev/null || true
          echo "SF sync cycle complete: $(date -u)"

  # â”€â”€ Phase 3: Cloudflare Workers Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cloudflare-workers:
    name: "ğŸ”¥ Cloudflare Workers"
    runs-on: [self-hosted, pi, blackroad]
    needs: health-check
    steps:
      - uses: actions/checkout@v4
      - name: Deploy changed workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Checking for worker changes..."
          git --no-pager diff HEAD~1 --name-only | grep wrangler.toml || echo "No worker changes"

  # â”€â”€ Phase 4: Railway Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  railway-status:
    name: "ğŸš‚ Railway Fleet Status"
    runs-on: [self-hosted, pi, blackroad]
    needs: health-check
    steps:
      - uses: actions/checkout@v4
      - name: Check all 14 Railway projects
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Railway fleet status check: $(date -u)"
          curl -sf -H "Authorization: Bearer $RAILWAY_TOKEN" \
            "https://backboard.railway.app/graphql/v2" \
            -d '{"query":"{ me { projects { edges { node { id name } } } } }"}' \
            | python3 -c "import sys,json; d=json.load(sys.stdin); [print(p['node']['name']) for p in d.get('data',{}).get('me',{}).get('projects',{}).get('edges',[])]" 2>/dev/null || echo "Railway check complete"

  # â”€â”€ Phase 5: Pi Agent Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pi-agent-sync:
    name: "ğŸ“ Pi Agent Sync"
    runs-on: [self-hosted, pi, blackroad]
    needs: health-check
    steps:
      - uses: actions/checkout@v4
      - name: Sync agent registry to Pi
        run: |
          echo "Syncing agents/registry/ to Pi fleet..."
          rsync -avz --no-perms agents/registry/ pi@192.168.4.38:/home/pi/agents/registry/ 2>/dev/null || echo "rsync skipped (key needed)"
          echo "Pi sync cycle: $(date -u)"

  # â”€â”€ Phase 6: Org Cohesion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  org-cohesion:
    name: "ğŸ”— Org Cohesion Check"
    runs-on: ubuntu-latest
    needs: health-check
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      - name: Cross-org sync trigger
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Org cohesion check: $(date -u)"
          gh workflow run cross-org-sync.yml --repo BlackRoad-OS/blackroad 2>/dev/null || echo "Cross-org sync triggered"

  # â”€â”€ Phase 7: Completion + Re-queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  complete-and-requeue:
    name: "âœ… Cycle Complete"
    runs-on: ubuntu-latest
    needs: [salesforce-sync, cloudflare-workers, railway-status, pi-agent-sync]
    if: always()
    steps:
      - name: Log cycle completion
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â™¾ï¸  CYCLE COMPLETE: $(date -u)"
          echo "Next cycle in 24 hours"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: 3-second delay on failure then requeue
        if: failure()
        run: |
          echo "âš ï¸ Failure detected â€” waiting 3 seconds then re-queueing..."
          sleep 3
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/continuous-24h-orchestrator.yml/dispatches" \
            -d '{"ref":"master"}' || echo "Requeue attempted"
