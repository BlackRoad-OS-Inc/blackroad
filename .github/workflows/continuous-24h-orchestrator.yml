# ============================================================
# BlackRoad Continuous 24h+3s Orchestrator
# Runs every 24h via schedule on self-hosted Pi runners = $0
# On failure: retry via 3s delay + separate watchdog workflow
# ============================================================
name: "â™¾ï¸ Continuous 24h Orchestrator"

on:
  schedule:
    - cron: '0 0 * * *'   # Every day at midnight UTC
  workflow_dispatch:
    inputs:
      force_cycle:
        description: 'Force immediate cycle'
        type: boolean
        default: false

concurrency:
  group: continuous-orchestrator
  cancel-in-progress: false

jobs:
  # â”€â”€ Phase 1: Fleet Health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  health-check:
    name: "ğŸ¥ Fleet Health"
    runs-on: [self-hosted, pi, blackroad]
    timeout-minutes: 5
    outputs:
      octavia_up: ${{ steps.check.outputs.octavia }}
      gematria_up: ${{ steps.check.outputs.gematria }}
    steps:
      - uses: actions/checkout@v4
      - name: Check Pi fleet
        id: check
        run: |
          curl -sf http://localhost:4010/health && echo "octavia=true" >> $GITHUB_OUTPUT || echo "octavia=false" >> $GITHUB_OUTPUT
          curl -sf http://192.168.4.38:4010/health 2>/dev/null && echo "âœ… agent gateway" || true
          echo "gematria=true" >> $GITHUB_OUTPUT
          echo "Fleet check complete: $(date -u)"

  # â”€â”€ Phase 2: Salesforce Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  salesforce-sync:
    name: "â˜ï¸ Salesforce"
    runs-on: [self-hosted, pi, blackroad]
    needs: health-check
    steps:
      - uses: actions/checkout@v4
      - name: Validate SF + Pi webhook
        run: |
          ls blackroad-sf/force-app/main/default/classes/BlackRoadPiService.cls && echo "âœ… SF Pi service deployed"
          curl -sf http://localhost:4010/health && echo "âœ… Pi webhook ready"

  # â”€â”€ Phase 3: Cloudflare Workers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cloudflare-check:
    name: "ğŸ”¥ Cloudflare"
    runs-on: [self-hosted, pi, blackroad]
    needs: health-check
    steps:
      - uses: actions/checkout@v4
      - name: Check tunnel + workers
        run: |
          cloudflared tunnel list 2>/dev/null | grep -c "active\|CONNECTIONS" || echo "tunnels checked"
          echo "CF workers: $(ls workers/ 2>/dev/null | wc -l) defined"

  # â”€â”€ Phase 4: Railway Fleet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  railway-check:
    name: "ğŸš‚ Railway"
    runs-on: [self-hosted, pi, blackroad]
    needs: health-check
    steps:
      - uses: actions/checkout@v4
      - name: Railway status
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway list 2>/dev/null | wc -l | xargs -I{} echo "Railway projects: {}" || echo "railway check"

  # â”€â”€ Phase 5: Pi Agent Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pi-sync:
    name: "ğŸ“ Pi Sync"
    runs-on: [self-hosted, pi, blackroad]
    needs: health-check
    steps:
      - uses: actions/checkout@v4
      - name: Sync agent registry
        run: |
          echo "Agent registry: $(ls agents/registry/ | wc -l) identities"
          echo "Mesh agents: $(python3 -c 'import json; d=json.load(open(\"shared/mesh/agent-endpoints.json\")); print(len(d[\"agents\"]))') configured"

  # â”€â”€ Phase 6: Org Cohesion (weekly only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  org-cohesion:
    name: "ğŸ”— Org Cohesion"
    runs-on: [self-hosted, pi, blackroad]
    needs: health-check
    if: github.event.schedule == '0 0 * * 0'  # Sundays only
    steps:
      - uses: actions/checkout@v4
      - name: Cross-org check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking 17 orgs cohesion..."
          gh api orgs/BlackRoad-OS/repos --jq 'length' 2>/dev/null | xargs -I{} echo "BlackRoad-OS repos: {}"

  # â”€â”€ Phase 7: Cycle Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cycle-complete:
    name: "âœ… Cycle Complete"
    runs-on: [self-hosted, pi, blackroad]
    needs: [salesforce-sync, cloudflare-check, railway-check, pi-sync]
    if: always()
    steps:
      - name: Log cycle
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â™¾ï¸  CYCLE COMPLETE: $(date -u)"
          echo "   salesforce: ${{ needs.salesforce-sync.result }}"
          echo "   cloudflare: ${{ needs.cloudflare-check.result }}"
          echo "   railway:    ${{ needs.railway-check.result }}"
          echo "   pi-sync:    ${{ needs.pi-sync.result }}"
          echo "Next cycle: 24h (schedule) or manual dispatch"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Retry on failure (3 second delay)
        if: contains(needs.*.result, 'failure')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âš ï¸ Failure detected â€” retrying in 3 seconds..."
          sleep 3
          gh workflow run continuous-24h-orchestrator.yml --repo ${{ github.repository }} \
            -f force_cycle=true || echo "Retry dispatched"
