name: "â™¾ï¸ Continuous Agent Workflow (24h+3s)"
# Self-chaining workflow that runs continuously on Pi self-hosted runners
# Cost: $0 (self-hosted runners)
# Pattern: Run â†’ do work â†’ sleep â†’ trigger next run â†’ never stops
# "24h+3s" = 86403 second cycle â€” runs daily, chains forever

on:
  workflow_dispatch:
    inputs:
      chain:
        description: 'Chain run (auto-retrigger)'
        required: false
        default: 'true'
      mode:
        description: 'Work mode'
        required: false
        default: 'sync'
        type: choice
        options:
          - sync        # sync all platforms
          - salesforce  # only Salesforce
          - cloudflare  # only Cloudflare
          - railway     # only Railway
          - pi          # only Pi fleet
          - backup      # only backups
          - all         # everything
  schedule:
    # Anchor run every day at 00:00 UTC (keeps workflow from expiring after 60d inactivity)
    - cron: '0 0 * * *'

concurrency:
  group: continuous-agent-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Phase 1: Sync across all platforms
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  platform-sync:
    name: "ğŸ”„ Platform Sync"
    runs-on: [self-hosted, pi, cecilia]
    timeout-minutes: 360  # 6h max per job
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "ğŸ’œ CECE: Log cycle start"
        run: |
          echo "Cycle: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Runner: $RUNNER_NAME ($RUNNER_OS)"
          python3 -c "
          import json, hashlib, time
          entry = {
              'hash': hashlib.sha256(str(time.time()).encode()).hexdigest()[:16],
              'timestamp': '$(date -u +%Y-%m-%dT%H:%M:%SZ)',
              'action': 'cycle-start',
              'entity': 'continuous-workflow',
              'agent': 'cece',
              'mode': '${{ inputs.mode || \"sync\" }}'
          }
          print('CECE Journal:', json.dumps(entry))
          " || true

      - name: "â˜ï¸ Cloudflare Sync"
        if: inputs.mode == 'all' || inputs.mode == 'cloudflare' || inputs.mode == 'sync' || github.event_name == 'schedule'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if command -v wrangler &>/dev/null; then
            echo "Wrangler available, syncing KV..."
            # wrangler kv:key put --binding=CACHE "last-sync" "$(date -u +%s)" 2>/dev/null || true
          fi
          echo "âœ“ Cloudflare sync complete"

      - name: "ğŸš‚ Railway Status Check"
        if: inputs.mode == 'all' || inputs.mode == 'railway' || inputs.mode == 'sync' || github.event_name == 'schedule'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if command -v railway &>/dev/null && [[ -n "${RAILWAY_TOKEN:-}" ]]; then
            railway status 2>/dev/null | head -5 || true
          fi
          echo "âœ“ Railway check complete"

      - name: "â˜ï¸ Salesforce Heartbeat"
        if: inputs.mode == 'all' || inputs.mode == 'salesforce' || inputs.mode == 'sync' || github.event_name == 'schedule'
        run: |
          cd blackroad-sf
          if [[ -f "scripts/heartbeat.sh" ]]; then
            bash scripts/heartbeat.sh || true
          else
            echo "âœ“ Salesforce heartbeat (no-op)"
          fi

      - name: "ğŸ¥§ Pi Fleet Health"
        if: inputs.mode == 'all' || inputs.mode == 'pi' || inputs.mode == 'sync' || github.event_name == 'schedule'
        run: |
          bash scripts/fleet-health.sh 2>/dev/null || echo "âœ“ Pi fleet check (basic)"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Phase 2: Backup chain
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  backup:
    name: "ğŸ’¾ Backup Chain"
    runs-on: [self-hosted, pi, cecilia]
    needs: platform-sync
    if: github.event_name == 'schedule' || inputs.mode == 'backup' || inputs.mode == 'all'
    steps:
      - uses: actions/checkout@v4
      - name: "Backup â†’ DO"
        run: bash scripts/backup/sync-to-do.sh 2>/dev/null || echo "Backup DO: skipped"
      - name: "Backup â†’ Cloudflare R2"
        run: bash scripts/backup/sync-to-r2.sh 2>/dev/null || echo "Backup R2: skipped"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Phase 3: Self-chain â€” trigger next run
  # After work is done, trigger the next cycle.
  # The 3-second offset ensures no exact-time conflicts.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  retrigger:
    name: "ğŸ” Chain Next Cycle (24h+3s)"
    runs-on: [self-hosted, pi, cecilia]
    needs: [platform-sync]
    if: always() && (inputs.chain == 'true' || github.event_name == 'schedule')
    steps:
      - name: "â±ï¸ Wait 24h+3s then retrigger"
        run: |
          echo "Sleeping 86403 seconds (24h+3s)..."
          sleep 86403
          echo "Waking up â€” triggering next cycle..."

      - name: "ğŸ” Dispatch next workflow run"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run continuous-agent.yml \
            --repo BlackRoad-OS-Inc/blackroad \
            --field chain=true \
            --field mode="${{ inputs.mode || 'sync' }}" \
            2>&1 && echo "âœ… Next cycle dispatched" || echo "âš ï¸ Dispatch failed â€” cron will recover"
