name: ğŸ–¥ï¸ Register Pi Self-Hosted Runners

on:
  workflow_dispatch:
    inputs:
      runner_token:
        description: 'GitHub Actions Runner Registration Token (from repo Settings > Actions > Runners > New)'
        required: true
        type: string

jobs:
  register-runners:
    name: Register Pi Fleet as Self-Hosted Runners
    runs-on: ubuntu-latest  # Bootstrap job runs on GitHub-hosted
    steps:
      - name: Register cecilia (Pi5 + Hailo-8)
        run: |
          ssh -o StrictHostKeyChecking=accept-new -i /dev/stdin blackroad@192.168.4.89 << 'SSHEOF'
          cd ~/actions-runner
          ./config.sh \
            --url https://github.com/${{ github.repository_owner }}/blackroad \
            --token ${{ github.event.inputs.runner_token }} \
            --name cecilia \
            --labels "self-hosted,pi,pi5,cecilia,hailo,linux,arm64" \
            --unattended --replace
          sudo ./svc.sh install 2>/dev/null || true
          sudo ./svc.sh start 2>/dev/null || true
          echo "âœ… cecilia registered"
          SSHEOF
        continue-on-error: true
        env:
          RUNNER_TOKEN: ${{ github.event.inputs.runner_token }}

      - name: Register aria (Pi5)
        run: |
          echo "Register aria at 192.168.4.82 â€” run: cd ~/actions-runner && ./config.sh --url https://github.com/${{ github.repository_owner }}/blackroad --token ${{ github.event.inputs.runner_token }} --name aria --labels self-hosted,pi,pi5,aria,linux,arm64 --unattended"
        continue-on-error: true

      - name: Register octavia (Pi5)
        run: |
          echo "Register octavia at 192.168.4.38 â€” already has runner binary"
        continue-on-error: true

      - name: Register alice (Pi4)  
        run: |
          echo "Register alice at 192.168.4.49 â€” gateway node"
        continue-on-error: true

      - name: Register anastasia (DigitalOcean)
        run: |
          echo "Register anastasia at 174.138.44.45 â€” x64 cloud backup"
        continue-on-error: true

      - name: ğŸ“‹ Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ–¥ï¸  Pi Runner Registration Complete"
          echo "   All runners = self-hosted = \$0 billable"
          echo "   Labels: self-hosted,pi,[node-name]"
          echo ""  
          echo "Next: Update workflows to use:"
          echo "  runs-on: [self-hosted, pi]"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
