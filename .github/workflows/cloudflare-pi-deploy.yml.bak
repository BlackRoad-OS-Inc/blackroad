# Cloudflare Deploy via Pi Self-Hosted Runner
# Cost: $0 ‚Äî runs on octavia/gematria
name: ‚òÅÔ∏è Cloudflare Pi Deploy

on:
  push:
    branches: [master, agent/aria]
    paths:
      - 'tools/cloudflare/**'
      - '.github/workflows/cloudflare-pi-deploy.yml'
  workflow_dispatch:
    inputs:
      worker:
        description: 'Worker name to deploy (empty = all)'
        required: false

jobs:
  deploy-workers:
    name: üöÄ Deploy Cloudflare Workers
    runs-on: [self-hosted, pi, blackroad, aria]
    steps:
      - uses: actions/checkout@v4

      - name: üì¶ Setup Wrangler
        run: |
          which wrangler || npm install -g wrangler
          wrangler --version

      - name: üîë Auth Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: echo "CF auth configured"

      - name: üöÄ Deploy Worker(s)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          WORKER="${{ github.event.inputs.worker }}"
          if [ -n "$WORKER" ]; then
            echo "Deploying specific worker: $WORKER"
            cd tools/cloudflare/$WORKER 2>/dev/null || echo "Worker not found: $WORKER"
            wrangler deploy
          else
            echo "Deploying all workers..."
            find tools/cloudflare -name "wrangler.toml" | while read wf; do
              DIR=$(dirname "$wf")
              echo "Deploying: $DIR"
              (cd "$DIR" && wrangler deploy) || echo "‚ö†Ô∏è Failed: $DIR"
            done
          fi
