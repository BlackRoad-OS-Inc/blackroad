name: Agent Identity Sync
on:
  push:
    branches: ['**']
  workflow_dispatch:

jobs:
  assign-identity:
    runs-on: [self-hosted, pi, blackroad]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Assign Agent Identity to Branch
        run: |
          BRANCH="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          ORG="${{ github.repository_owner }}"
          
          # Determine agent from branch prefix
          case "$BRANCH" in
            main|master)           AGENT="CECE" ;;
            feat/sf-*|feat/salesforce-*) AGENT="ALICE" ;;
            feat/infra-*|feat/deploy-*|feat/ci-*|release/*) AGENT="OCTAVIA" ;;
            feat/ai-*|feat/model-*|feat/ml-*|codex/*) AGENT="LUCIDIA" ;;
            feat/sec-*|feat/security-*|feat/vault-*) AGENT="CIPHER" ;;
            feat/ui-*|feat/frontend-*|feat/ux-*) AGENT="ARIA" ;;
            feat/data-*|feat/analytics-*) AGENT="PRISM" ;;
            feat/mem-*|feat/memory-*) AGENT="ECHO" ;;
            feat/hack-*|feat/research-*) AGENT="SHELLFISH" ;;
            hotfix/*|fix/*|chore/*) AGENT="ALICE" ;;
            bot/*|claude/*|copilot/*) AGENT="CECE" ;;
            *)                     AGENT="CECE" ;;
          esac
          
          # Determine agent from org
          case "$ORG" in
            BlackRoad-AI)          ORG_AGENT="LUCIDIA" ;;
            BlackRoad-Security)    ORG_AGENT="CIPHER" ;;
            BlackRoad-Cloud|BlackRoad-Hardware) ORG_AGENT="OCTAVIA" ;;
            BlackRoad-Media|BlackRoad-Interactive|BlackRoad-Studio) ORG_AGENT="ARIA" ;;
            BlackRoad-Labs)        ORG_AGENT="PRISM" ;;
            BlackRoad-Education)   ORG_AGENT="ECHO" ;;
            Blackbox-Enterprises)  ORG_AGENT="ALICE" ;;
            BlackRoad-Gov|BlackRoad-Security) ORG_AGENT="CIPHER" ;;
            *)                     ORG_AGENT="$AGENT" ;;
          esac
          
          echo "ğŸ¤– Branch Agent: $AGENT"
          echo "ğŸ¢ Org Agent:    $ORG_AGENT"
          echo "ğŸŒ¿ Branch:       $BRANCH"
          echo "ğŸ“¦ Repo:         $REPO"
          
          # Write identity file
          cat > .agent-identity.json << AGENTEOF
{
  "branch": "$BRANCH",
  "agent": "$AGENT",
  "org_agent": "$ORG_AGENT",
  "repo": "$REPO",
  "org": "$ORG",
  "assigned_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "gateway": "http://192.168.4.38:4010",
  "model": "qwen2.5:3b",
  "cost": "$0"
}
AGENTEOF
          echo "âœ… Identity written to .agent-identity.json"
          cat .agent-identity.json

      - name: Post Identity to Agent Bridge
        continue-on-error: true
        run: |
          AGENT=$(cat .agent-identity.json | python3 -c "import sys,json; print(json.load(sys.stdin)['agent'])")
          curl -s -X POST http://192.168.4.38:4010/identity \
            -H "Content-Type: application/json" \
            -d @.agent-identity.json \
            --connect-timeout 5 || echo "Bridge offline - identity stored locally"
